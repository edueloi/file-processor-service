<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>File Processor Service — Demo Frontend</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#11161d; --muted:#8aa0b3; --text:#e7edf3;
    --primary:#3aa0ff; --primary-2:#0872d5; --ok:#2ecc71; --err:#ff6b6b;
    --border:#1e2935;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  header{
    position:sticky; top:0; z-index:5;
    background:linear-gradient(180deg,var(--panel),#0f141b);
    border-bottom:1px solid var(--border);
  }
  .topbar{max-width:1100px;margin:0 auto;padding:14px 20px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="text"]{
    background:#0a0f15;border:1px solid var(--border);color:var(--text);
    padding:8px 10px;border-radius:10px;min-width:280px;outline:none;
  }
  button{
    background:var(--primary);border:0;color:white;border-radius:12px;
    padding:9px 14px;cursor:pointer;font-weight:600
  }
  button:hover{background:var(--primary-2)}
  button:disabled{opacity:.6;cursor:not-allowed}
  main{max-width:1100px;margin:24px auto;padding:0 20px;display:grid;gap:18px}
  section{
    background:var(--panel); border:1px solid var(--border); border-radius:14px;
    padding:16px 16px 18px;
  }
  section h2{margin:0 0 10px 0; font-size:18px}
  .grid{display:grid; gap:14px}
  .col-2{grid-template-columns: 1fr 1fr}
  label{display:block; font-weight:600; margin:4px 0 6px}
  textarea{
    width:100%; min-height:260px; resize:vertical; background:#0a0f15; color:var(--text);
    border:1px solid var(--border); border-radius:12px; padding:10px 12px;
    font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px;
  }
  .small{font-size:12.5px}
  pre.viewer{
    background:#0a0f15; border:1px solid var(--border); border-radius:12px; padding:12px;
    overflow:auto; max-height:420px; white-space:pre-wrap;
  }
  .tag{display:inline-flex;align-items:center;gap:6px;background:#0b1320;border:1px solid var(--border);color:var(--muted);padding:5px 9px;border-radius:999px}
  .right{margin-left:auto}
  .hr{border-top:1px solid var(--border); margin:8px 0 4px}
  a.link{color:#a5d8ff; text-decoration:none}
  .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;background:#999}
  .ok{background:var(--ok)!important}
  .err{background:var(--err)!important}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .hint{color:#9db2c7}
  .inline{display:inline}
</style>
</head>
<body>
  <header>
    <div class="topbar">
      <h1>File Processor Service — <span class="muted">Demo</span></h1>
      <div class="row right">
        <span id="statusDot" class="status-dot"></span><span id="statusText" class="muted">desconectado</span>
      </div>
      <div class="row" style="width:100%">
        <label class="small" for="baseUrl">Base URL da API</label>
        <input id="baseUrl" type="text" value="http://127.0.0.1:3001" />
        <button id="btnPing">Testar conexão</button>
        <a class="link" id="manualLink" href="#" target="_blank" rel="noopener">Abrir Manual</a>
        <span class="tag">v6.x (FastAPI)</span>
      </div>
    </div>
  </header>

  <main>
    <!-- Criar PDF -->
    <section>
      <h2>1) Gerar PDF</h2>
      <div class="grid col-2">
        <div>
          <label for="payload">Payload JSON (<span class="inline muted">DynamicPDF</span>)</label>
          <textarea id="payload" spellcheck="false"></textarea>
          <div class="chips">
            <button type="button" id="btnSnippetHeading">+ heading</button>
            <button type="button" id="btnSnippetParagraph">+ paragraph</button>
            <button type="button" id="btnSnippetBullets">+ bullet_list</button>
            <button type="button" id="btnSnippetImage">+ image (base64)</button>
            <button type="button" id="btnLoadSample" title="Substitui o conteúdo do editor">Carregar exemplo completo</button>
          </div>
        </div>
        <div>
          <label>Download</label>
          <div class="row">
            <button id="btnCreate" style="min-width:160px">Gerar PDF</button>
            <span id="createMsg" class="muted"></span>
          </div>
          <div class="hr"></div>
          <p class="small hint">
            Dica: você pode colar um <code>data:image/png;base64,...</code> em <code>content.base64_data</code> ou usar <code>content.src</code> com uma URL http(s).<br/>
            Use <code>options.margins_mm</code> para ajustar margens e <code>content.align</code> para L/C/R.
          </p>
          <div class="hr"></div>
          <label for="imgB64">Converter imagem local para Base64 (opcional)</label>
          <input type="file" id="imgFile" accept="image/*" />
          <button id="btnToBase64">Gerar Base64</button>
          <pre id="b64Out" class="viewer small" style="display:none"></pre>
        </div>
      </div>
    </section>

    <!-- Extrair texto -->
    <section>
      <h2>2) Extrair Texto (PDF/DOCX/XLSX/TXT)</h2>
      <div class="grid col-2">
        <div>
          <label for="file">Arquivo</label>
          <input id="file" type="file" />
          <div class="row">
            <button id="btnExtractJson">Extrair como JSON</button>
            <button id="btnExtractTxt">Baixar .txt</button>
          </div>
          <p class="small hint">
            Para JSON, o retorno vem com: <code>filename</code>, <code>content_type</code>, <code>length</code> e <code>extracted_text</code>.
          </p>
        </div>
        <div>
          <label>Resultado (JSON)</label>
          <pre id="out" class="viewer"></pre>
        </div>
      </div>
    </section>
  </main>

<script>
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

const baseUrlInput = $('#baseUrl');
const statusDot = $('#statusDot');
const statusText = $('#statusText');
const manualLink = $('#manualLink');

function setStatus(ok, msg){
  statusDot.classList.toggle('ok', !!ok);
  statusDot.classList.toggle('err', ok === false);
  statusText.textContent = msg || (ok ? 'online' : 'erro');
}

async function ping(){
  const base = baseUrlInput.value.trim().replace(/\/+$/,'');
  manualLink.href = base + '/manual';
  setStatus(null, 'testando...');
  try{
    const r = await fetch(base + '/', {method:'GET'});
    if(!r.ok) throw new Error(r.status + ' ' + r.statusText);
    const j = await r.json();
    setStatus(true, `online — versão ${j.version || 'N/D'}`);
  }catch(e){
    setStatus(false, 'falha na conexão');
    console.error(e);
  }
}

$('#btnPing').addEventListener('click', ping);
window.addEventListener('load', () => { loadSample(); ping(); });

/* --------- Helpers fetch --------- */
async function postJson(url, body){
  const r = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!r.ok){
    let detail = '';
    try{ const j = await r.json(); detail = j.detail || ''; }catch(_){}
    throw new Error(`HTTP ${r.status} ${r.statusText}${detail ? ' — ' + detail : ''}`);
  }
  return r;
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* --------- Criar PDF --------- */
const payloadEl = $('#payload');
const createMsg = $('#createMsg');

$('#btnCreate').addEventListener('click', async () => {
  createMsg.textContent = 'enviando...';
  $('#btnCreate').disabled = true;
  try{
    let data;
    try{
      data = JSON.parse(payloadEl.value);
    }catch(e){
      throw new Error('JSON inválido no editor.');
    }
    const base = baseUrlInput.value.trim().replace(/\/+$/,'');
    const r = await postJson(base + '/api/create-pdf?download=true', data);
    const blob = await r.blob();
    const name = (data.filename || 'documento') + '.pdf';
    downloadBlob(blob, name);
    createMsg.textContent = 'PDF gerado com sucesso ✅';
  }catch(e){
    console.error(e);
    createMsg.textContent = 'Erro: ' + e.message;
  }finally{
    $('#btnCreate').disabled = false;
  }
});

/* Snippets para facilitar */
function insertAtCursor(textarea, snippet){
  const start = textarea.selectionStart, end = textarea.selectionEnd;
  const before = textarea.value.slice(0,start);
  const after = textarea.value.slice(end);
  textarea.value = before + snippet + after;
  textarea.selectionStart = textarea.selectionEnd = start + snippet.length;
  textarea.focus();
}

$('#btnSnippetHeading').onclick = () => insertAtCursor(payloadEl,
`{
  "type": "heading",
  "content": "Título da seção"
},
`);
$('#btnSnippetParagraph').onclick = () => insertAtCursor(payloadEl,
`{
  "type": "paragraph",
  "content": "Texto do parágrafo...",
  "align": "L",
  "line_height": 6.0
},
`);
$('#btnSnippetBullets').onclick = () => insertAtCursor(payloadEl,
`{
  "type": "bullet_list",
  "content": ["Item 1", "Item 2", "Item 3"]
},
`);
$('#btnSnippetImage').onclick = () => insertAtCursor(payloadEl,
`{
  "type": "image",
  "content": {
    "base64_data": "iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAGElEQVR4nGP8z8Dwn4EIwESMolGF1FMIAD2cAhK2AyPVAAAAAElFTkSuQmCC",
    "width": 60,
    "align": "C"
  }
},
`);

$('#btnLoadSample').onclick = loadSample;

function loadSample(){
  payloadEl.value = JSON.stringify({
    "filename": "relatorio_demo",
    "title": "Relatório de Atividades - Demo",
    "options": {
      "author": "Equipe Demo",
      "page_numbers": true,
      "margins_mm": [17, 15, 17],
      "allow_remote_images": true
    },
    "content_blocks": [
      { "type": "heading", "content": "1. Visão Geral" },
      { "type": "paragraph", "content": "Este relatório apresenta os principais indicadores e entregas do mês." },
      { "type": "bullet_list", "content": ["Feature X entregue", "Integração Y publicada", "Correções críticas resolvidas"] },
      { "type": "subheading", "content": "Indicadores-Chave", "style": { "background_color": [245,245,245] } },
      { "type": "key_value", "content": { "Projetos": "5", "Entregas": "12", "Erros críticos": "0" } },
      { "type": "spacer", "content": 6 },
      {
        "type": "image",
        "content": { "base64_data": "iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAGElEQVR4nGP8z8Dwn4EIwESMolGF1FMIAD2cAhK2AyPVAAAAAElFTkSuQmCC", "width": 60, "align": "C" }
      },
      { "type": "paragraph", "content": "Conclusão centrada.", "align": "C", "line_height": 7.2 }
    ]
  }, null, 2);
}

/* Conversor de imagem -> Base64 (para colar no JSON) */
$('#btnToBase64').addEventListener('click', async () => {
  const f = $('#imgFile').files[0];
  if(!f){ alert('Escolha uma imagem.'); return; }
  const buf = await f.arrayBuffer();
  const b64 = arrayBufferToBase64(buf);
  const mime = f.type || 'image/png';
  const dataUrl = `data:${mime};base64,${b64}`;
  const out = $('#b64Out');
  out.style.display = 'block';
  out.textContent = dataUrl;
});

function arrayBufferToBase64(buffer){
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

/* --------- Extrair texto --------- */
$('#btnExtractJson').addEventListener('click', async () => {
  $('#out').textContent = '';
  const fi = $('#file').files[0];
  if(!fi){ alert('Escolha um arquivo.'); return; }
  try{
    const base = baseUrlInput.value.trim().replace(/\/+$/,'');
    const fd = new FormData();
    fd.append('file', fi, fi.name);
    const r = await fetch(base + '/api/process-file?return_as=json', {method:'POST', body:fd});
    if(!r.ok){
      let detail=''; try{ const j = await r.json(); detail = j.detail || ''; }catch(_){}
      throw new Error(`HTTP ${r.status} ${r.statusText}${detail ? ' — ' + detail : ''}`);
    }
    const j = await r.json();
    $('#out').textContent = JSON.stringify(j, null, 2);
  }catch(e){
    console.error(e);
    $('#out').textContent = 'Erro: ' + e.message;
  }
});

$('#btnExtractTxt').addEventListener('click', async () => {
  const fi = $('#file').files[0];
  if(!fi){ alert('Escolha um arquivo.'); return; }
  try{
    const base = baseUrlInput.value.trim().replace(/\/+$/,'');
    const fd = new FormData();
    fd.append('file', fi, fi.name);
    const r = await fetch(base + '/api/process-file?return_as=txt&download=true', {method:'POST', body:fd});
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const blob = await r.blob();
    const name = (fi.name.replace(/\.[^/.]+$/,'') || 'texto') + '.txt';
    downloadBlob(blob, name);
  }catch(e){
    alert('Erro: ' + e.message);
  }
});
</script>
</body>
</html>
